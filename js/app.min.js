var map,markers=ko.observableArray(),locations=[{title:"Statue of Liberty",location:{lat:40.689249,lng:-74.0445},pictures:[]},{title:"Grand Central Terminal",location:{lat:40.752726,lng:-73.977229},pictures:[]},{title:"Rockefeller Center",location:{lat:40.75874,lng:-73.978674},pictures:[]},{title:"Times Square",location:{lat:40.759011,lng:-73.984472},pictures:[]},{title:"Madison Square Garden",location:{lat:40.750506,lng:-73.993394},pictures:[]},{title:"Empire State Building",location:{lat:40.748441,lng:-73.985664},pictures:[]},{title:"Metropolitan Museum of Art",location:{lat:40.779187,lng:-73.963535},pictures:[]},{title:"Bryant Park",location:{lat:40.753597,lng:-73.983233},pictures:[]},{title:"World Trade Center site",location:{lat:40.711801,lng:-74.01312},pictures:[]},{title:"Frick Collection",location:{lat:40.771181,lng:-73.96735},pictures:[]},{title:"Yankee Stadium",location:{lat:40.828819,lng:-73.926569},pictures:[]}],ViewModel=function(){var t=this;this.siteList=ko.observableArray(),this.sitePics=ko.observableArray(),this.siteInfo=ko.observableArray(),this.initListView=function(){locations.forEach(function(e){t.siteList.push(e)}),t.getSitePhotos(),t.getSiteExtract(),t.drawMap()},this.getSitePhotos=function(){var t,e,i,o;locations.forEach(function(r){i=r.title.replace(/\s/g,""),t="https://api.flickr.com/services/rest/?method=flickr.photos.search&api_key=8464c6c6332cf769ce0a9f0d5b55fd91&sort=interestingness-asc&tags="+i+"&per_page=10&page=1&format=json&nojsoncallback=1",$.ajax({type:"GET",data:o,url:t,success:function(t){o=t.photos.photo,o.forEach(function(t){e="https://farm"+t.farm+".static.flickr.com/"+t.server+"/"+t.id+"_"+t.secret+".jpg",r.pictures.push(e)})},error:function(){alert("We're sorry but the Flickr API failed to download photos of "+r.title+" in New York City")}})})},this.getSiteExtract=function(){var e,i,o;locations.forEach(function(r){i=r.title.replace(/\s/g,"+"),e="https://en.wikipedia.org/w/api.php?action=query&format=json&prop=extracts&titles="+i+"&exsentences=2&explaintext=1",$.ajax({type:"GET",data:o,url:e,contentType:"text/plain",withCredentials:!1,crossDomain:!0,dataType:"jsonp",success:function(e){o=e.query.pages[Object.keys(e.query.pages)[0]].extract,t.newInfoWindow(o),t.newMarker(r.location,r.title,r)},error:function(){alert("We're sorry but the WIKIPEDIA API failed to download extract of "+r.title+" in New York City")}})})},this.restoreList=function(){locations.forEach(function(e){t.siteList.push(e)})},this.restoreMarker=function(t){markers()[t].setMap(map)},this.removeMarker=function(t){markers()[t].setMap(null)},this.toggleAnimation=function(t){t.setAnimation(null!==t.getAnimation()?null:google.maps.Animation.BOUNCE)},this.setCurrentMarker=function(e){var i;if(t.siteList().length>1){t.siteList.removeAll(),t.siteList.push(e);for(i in markers())markers()[i].title!=e.title?t.removeMarker(i):(t.toggleAnimation(markers()[i]),t.siteInfo()[i].open(map,markers()[i]));e.pictures.forEach(function(e){t.sitePics.push(e)})}else{for(i in markers())markers()[i].title!=e.title?t.restoreMarker(i):(t.toggleAnimation(markers()[i]),t.siteInfo()[i].close(map,markers()[i]));t.siteList.removeAll(),t.restoreList(),t.sitePics.removeAll()}},this.query=ko.observable(""),this.search=function(e){t.siteList.removeAll();for(var i in locations)locations[i].title.toLowerCase().indexOf(e.toLowerCase())<0?t.removeMarker(i):(t.siteList.push(locations[i]),markers()[i].setMap(map))},this.query.subscribe(this.search),this.drawMap=function(){map=new google.maps.Map(document.getElementById("map"),{center:{lat:40.768582,lng:-73.98056},map:map,zoom:12})},this.newInfoWindow=function(e){var i=new google.maps.InfoWindow({content:e});t.siteInfo.push(i)},this.newMarker=function(e,i,o){var r=new google.maps.Marker({position:e,animation:google.maps.Animation.DROP,map:map,title:i});r.addListener("click",function(){t.setCurrentMarker(o)}),markers.push(r)},/*!
    * Initializing List and Google Map
    */
t.initListView()};ko.applyBindings(new ViewModel);